{% extends "layout.html" %}

{% block title %}Enviar Broadcast{% endblock %}
{% block page_title %}Enviar Broadcast{% endblock %} {# Title for the main header #}

{% block content %}
<div class="form-container"> {# Uses the form container for centering and styling #}
    <div class="card" style="max-width: 48rem; width: 100%; padding: 2.5rem;"> {# Adjust max-width and padding to match original Tailwind #}
        <h2 class="section-title text-center" style="margin-bottom: 2rem;">
            <span style="display: block; font-size: 2.25rem; font-weight: 800; color: var(--text);">üöÄ Enviar Mensagem de Broadcast</span> {# text-4xl font-extrabold text-gray-900 #}
            <span style="display: block; font-size: 1.25rem; font-weight: 500; color: var(--primary); margin-top: 0.5rem;">Alcance todos os seus usu√°rios ativos!</span> {# text-xl font-medium text-indigo-700 #}
        </h2>

        {# Flash messages are already handled by layout.html, so this block is redundant here. #}
        {# Removed:
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-lg shadow-md flex items-center {{ 'bg-green-100 text-green-800' if category == 'success' else ('bg-red-100 text-red-800' if category == 'danger' else 'bg-blue-100 text-blue-800') }}">
                            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                ...
                            </svg>
                            <p class="text-sm font-medium">{{ message }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        #}

        <form method="POST" action="{{ url_for('send_broadcast') }}" class="form-grid"> {# space-y-6 #}
            <div>
                <label for="message_text" class="form-label" style="font-size: 1.125rem;"> {# text-lg font-semibold #}
                    Conte√∫do da Mensagem <span style="color: var(--danger);">*</span>
                </label>
                <textarea name="message_text" id="message_text" rows="8" required
                          class="form-textarea"
                          placeholder="Digite a mensagem que deseja enviar para todos os usu√°rios..."
                >{{ message_text_val | default('', true) }}</textarea>
                <p class="form-hint" style="margin-top: 0.5rem;"> {# mt-2 text-sm #}
                    Suporta formata√ß√£o Markdown (ex: *negrito*, _it√°lico_, `c√≥digo`).
                </p>
            </div>

            <div>
                <label for="image_url" class="form-label" style="font-size: 1.125rem;"> {# text-lg font-semibold #}
                    URL da Imagem (Opcional)
                </label>
                <input type="url" name="image_url" id="image_url"
                       class="form-input"
                       placeholder="Ex: https://seusite.com/imagem.jpg"
                       value="{{ image_url_val | default('', true) }}">
                <p class="form-hint" style="margin-top: 0.5rem;"> {# mt-2 text-sm #}
                    Cole o link direto de uma imagem para enviar junto com a mensagem.
                </p>
            </div>

            <div class="preview-section"> {# New class for preview section #}
                <h3 class="section-subtitle" style="margin-bottom: 1rem;">Pr√©-visualiza√ß√£o da Mensagem</h3> {# text-xl font-bold #}
                <div id="preview-area" class="preview-box"> {# New classes for preview box #}
                    <p id="preview-text" class="preview-text-content"></p> {# New class for text content #}
                    <img id="preview-image" src="" alt="Pr√©-visualiza√ß√£o da Imagem" class="preview-image hidden"> {# New class for image #}
                    <p id="preview-placeholder" class="preview-placeholder">
                        Digite sua mensagem ou adicione uma URL de imagem para pr√©-visualizar aqui.
                    </p>
                </div>
            </div>

            <div class="form-actions" style="justify-content: flex-end; gap: 1rem; padding-top: 1.5rem;"> {# flex justify-end gap-x-4 pt-6 #}
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary btn-icon"> {# Added btn-icon for consistent styling #}
                    <span class="material-icons" style="margin-right: 0.5rem;">send</span> {# Material Icons send icon #}
                    Enviar Broadcast
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageTextInput = document.getElementById('message_text');
        const imageUrlInput = document.getElementById('image_url');
        const previewTextArea = document.getElementById('preview-text');
        const previewImage = document.getElementById('preview-image');
        const previewPlaceholder = document.getElementById('preview-placeholder');

        function updatePreview() {
            const messageText = messageTextInput.value;
            const imageUrl = imageUrlInput.value;

            // Simple Markdown to HTML conversion (for bold and italic)
            let formattedText = messageText
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>') // Bold
                .replace(/_(.*?)_/g, '<em>$1</em>')     // Italic
                .replace(/`(.*?)`/g, '<code>$1</code>') // Code
                .replace(/\n/g, '<br>'); // Handle new lines for preview

            previewTextArea.innerHTML = formattedText || '';

            if (imageUrl) {
                previewImage.src = imageUrl;
                previewImage.classList.remove('hidden');
                previewImage.onload = () => {
                    previewPlaceholder.classList.add('hidden');
                    // Ensure text content is not empty if image loads and text is also there
                    if (!messageText.trim()) { // If only spaces, treat as empty
                        previewPlaceholder.classList.add('hidden'); // Placeholder hidden if image loads
                    }
                };
                previewImage.onerror = () => {
                    previewImage.classList.add('hidden');
                    previewImage.src = '';
                    if (!messageText.trim()) { // If no text and image fails, show placeholder
                        previewPlaceholder.classList.remove('hidden');
                    }
                };
            } else {
                previewImage.classList.add('hidden');
                previewImage.src = '';
            }

            // Show/hide placeholder based on content
            if (!messageText.trim() && !imageUrl) {
                previewPlaceholder.classList.remove('hidden');
            } else {
                previewPlaceholder.classList.add('hidden');
            }
        }

        // Initial preview update
        updatePreview();

        // Listen for input changes
        messageTextInput.addEventListener('input', updatePreview);
        imageUrlInput.addEventListener('input', updatePreview);
    });
</script>
{% endblock %}